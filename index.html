<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ğŸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ø¨Ø§Ù„ÙŠØ¯ ğŸ - Ù…Ø¬Ø§Ù†ÙŠ</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      color: white;
      font-family: "Cairo", sans-serif;
      text-align: center;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      touch-action: none;
    }
    
    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      margin: 0 auto;
      overflow: hidden;
    }
    
    #camera-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #game-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }
    
    #score {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 24px;
      z-index: 5;
      background: rgba(0, 0, 0, 0.7);
      color: lime;
      padding: 10px 20px;
      border-radius: 20px;
      pointer-events: none;
    }
    
    #instructions {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 18px;
      color: white;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      z-index: 5;
      pointer-events: none;
    }
    
    #controls {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: auto;
    }
    
    .control-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: 2px solid lime;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      font-family: "Cairo", sans-serif;
      transition: all 0.3s;
    }
    
    .control-btn:hover {
      background: rgba(0, 255, 0, 0.2);
      transform: translateY(-2px);
    }
    
    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10;
    }
    
    #start-screen, #game-over-screen, #permission-screen {
      text-align: center;
      padding: 30px;
      max-width: 90%;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 20px;
      border: 2px solid lime;
      box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
    }
    
    h1 {
      font-size: 36px;
      margin-bottom: 20px;
      color: lime;
      text-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
    }
    
    h2 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #ffcc00;
    }
    
    p {
      font-size: 18px;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .error-message {
      color: #ff6b6b;
      background: rgba(255, 0, 0, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border: 1px solid #ff6b6b;
    }
    
    .troubleshoot-list {
      text-align: right;
      margin: 15px 0;
      padding-right: 20px;
    }
    
    .troubleshoot-list li {
      margin-bottom: 10px;
    }
    
    button {
      background: linear-gradient(to bottom, #4CAF50, #2E7D32);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 20px;
      border-radius: 30px;
      cursor: pointer;
      font-family: "Cairo", sans-serif;
      margin: 15px 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s;
      pointer-events: auto;
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      background: linear-gradient(to bottom, #5CB860, #3E8E41);
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    #loading {
      font-size: 20px;
      margin-top: 20px;
      color: #aaa;
    }
    
    .particle {
      position: absolute;
      pointer-events: none;
      border-radius: 50%;
      opacity: 0.7;
      z-index: 3;
    }
    
    video {
      display: none;
    }
    
    .permission-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
    
    #hand-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 80px;
      opacity: 0.7;
      z-index: 2;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .game-title {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      z-index: 5;
      background: rgba(0, 0, 0, 0.7);
      color: lime;
      padding: 10px 25px;
      border-radius: 20px;
      pointer-events: none;
      border: 1px solid lime;
    }
    
    /* Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø·ÙˆØ± */
    #developer-info {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 5;
      background: rgba(0, 0, 0, 0.7);
      color: #aaa;
      padding: 8px 15px;
      border-radius: 15px;
      font-size: 14px;
      pointer-events: none;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    #developer-name {
      color: lime;
      font-weight: bold;
      margin-bottom: 2px;
    }
    
    #free-badge {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 70px;
      background: linear-gradient(45deg, #4CAF50, #2E7D32);
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 14px;
      z-index: 5;
      pointer-events: none;
      border: 1px solid lime;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }
    
    .developer-section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(0, 255, 0, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 0, 0.3);
    }
    
    .developer-section h3 {
      color: lime;
      margin-bottom: 10px;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡ÙˆØ§ØªÙ */
    @media (max-width: 768px) {
      .game-title {
        font-size: 20px;
        padding: 8px 15px;
      }
      
      #score {
        font-size: 18px;
        padding: 8px 15px;
      }
      
      #controls {
        top: 10px;
        right: 10px;
        gap: 5px;
      }
      
      .control-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      #instructions {
        font-size: 16px;
        padding: 8px;
      }
      
      #start-screen, #game-over-screen, #permission-screen {
        padding: 20px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      h2 {
        font-size: 24px;
      }
      
      p {
        font-size: 16px;
      }
      
      button {
        padding: 12px 25px;
        font-size: 18px;
      }
      
      #free-badge {
        font-size: 12px;
        padding: 4px 10px;
      }
      
      #developer-info {
        font-size: 12px;
        padding: 6px 12px;
      }
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 480px) {
      .game-title {
        font-size: 18px;
        padding: 6px 12px;
      }
      
      #score {
        font-size: 16px;
        padding: 6px 12px;
      }
      
      .control-btn {
        padding: 6px 10px;
        font-size: 11px;
      }
      
      #instructions {
        font-size: 14px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      button {
        padding: 10px 20px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="camera-canvas"></canvas>
    
    <div id="game-overlay">
      <div class="game-title">ğŸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ø¨Ø§Ù„ÙŠØ¯ ğŸ</div>
      <div id="free-badge">ğŸ†“ Ù…Ø¬Ø§Ù†ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</div>
      <div id="score">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
      <div id="instructions">Ø­Ø±Ùƒ Ø¥ØµØ¨Ø¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† ÙˆØ¬Ù…Ø¹ Ø§Ù„ØªÙØ§Ø­ Ø§Ù„Ø£Ø­Ù…Ø±</div>
      
      <div id="controls">
        <button class="control-btn" id="camera-switch">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="control-btn" id="manual-mode-btn">Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ</button>
      </div>
      
      <div id="hand-indicator">âœ‹</div>
      
      <!-- Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø·ÙˆØ± -->
      <div id="developer-info">
        <div id="developer-name">Ø¹Ø¨Ø¯ Ø§Ù„ÙˆÙ‡Ø§Ø¨ Ø¹Ø¨Ø¯ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø±ÙŠÙ…ÙŠ</div>
        <div>Ù…Ø·ÙˆØ± Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
      </div>
    </div>
    
    <div id="overlay">
      <div id="start-screen">
        <h2>ğŸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† Ø¨Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙŠØ¯ ğŸ</h2>
        <div class="developer-section">
          <h3>ğŸ†“ Ù„Ø¹Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</h3>
          <p>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø¯Ø¹Ù… ÙˆØªÙØ§Ù†Ù Ù„ØªÙ‚Ø¯ÙŠÙ… ØªØ¬Ø±Ø¨Ø© Ù„Ø¹Ø¨ Ù…Ù…ØªØ¹Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</p>
        </div>
        <p>Ø§Ø³ØªØ®Ø¯Ù… Ø¥ØµØ¨Ø¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø­Ø±ÙƒØ© Ø§Ù„Ø«Ø¹Ø¨Ø§Ù† ÙˆØ¬Ù…Ø¹ Ø§Ù„ØªÙØ§Ø­ Ø§Ù„Ø£Ø­Ù…Ø±!</p>
        <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ø§Ù„Ù„Ù…Ø³</p>
        
        <div class="developer-section">
          <h3>ğŸ‘¨â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±</h3>
          <p><strong>Ø¹Ø¨Ø¯ Ø§Ù„ÙˆÙ‡Ø§Ø¨ Ø¹Ø¨Ø¯ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø±ÙŠÙ…ÙŠ</strong></p>
          <p>Ù…Ø·ÙˆØ± Ø£Ù„Ø¹Ø§Ø¨ ÙˆØªØ·Ø¨ÙŠÙ‚Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©</p>
        </div>
        
        <button id="start-button">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¬Ø§Ù†Ø§Ù‹</button>
        <div id="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ¯...</div>
      </div>
      
      <div id="game-over-screen" style="display: none;">
        <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2>
        <p id="final-score">Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: 0</p>
        
        <div class="developer-section">
          <h3>Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ø¹Ø¨! ğŸ®</h3>
          <p>Ù„Ø¹Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† <strong>Ø¹Ø¨Ø¯ Ø§Ù„ÙˆÙ‡Ø§Ø¨ Ø¹Ø¨Ø¯ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø±ÙŠÙ…ÙŠ</strong></p>
        </div>
        
        <button id="restart-button">ğŸ”„ Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù…Ø¬Ø§Ù†Ø§Ù‹</button>
      </div>
      
      <div id="permission-screen" style="display: none;">
        <div class="permission-icon">ğŸ“·</div>
        <h2>Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h2>
        <div class="error-message" id="error-details">
          ØªØ¹Ø°Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‡Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
        </div>
        <p>Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§ØªØ¨Ø§Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
        <ul class="troubleshoot-list">
          <li>Ø£ØºÙ„Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</li>
          <li>Ø£ØºÙ„Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­</li>
          <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</li>
          <li>Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</li>
        </ul>
        
        <div class="developer-section">
          <p>Ù„Ø¹Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù…Ù† ØªØ·ÙˆÙŠØ± <strong>Ø¹Ø¨Ø¯ Ø§Ù„ÙˆÙ‡Ø§Ø¨ Ø¹Ø¨Ø¯ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø±ÙŠÙ…ÙŠ</strong></p>
        </div>
        
        <button id="retry-button">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        <button id="manual-mode-button">Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ø¯ÙˆÙ† ÙƒØ§Ù…ÙŠØ±Ø§</button>
      </div>
    </div>
  </div>

  <video id="video" autoplay playsinline></video>

  <script>
    const video = document.getElementById("video");
    const cameraCanvas = document.getElementById("camera-canvas");
    const cameraCtx = cameraCanvas.getContext("2d");
    const startButton = document.getElementById("start-button");
    const restartButton = document.getElementById("restart-button");
    const retryButton = document.getElementById("retry-button");
    const manualModeButton = document.getElementById("manual-mode-button");
    const manualModeBtn = document.getElementById("manual-mode-btn");
    const startScreen = document.getElementById("start-screen");
    const gameOverScreen = document.getElementById("game-over-screen");
    const permissionScreen = document.getElementById("permission-screen");
    const loadingElement = document.getElementById("loading");
    const scoreElement = document.getElementById("score");
    const finalScoreElement = document.getElementById("final-score");
    const errorDetailsElement = document.getElementById("error-details");
    const overlay = document.getElementById("overlay");
    const cameraSwitch = document.getElementById("camera-switch");
    const handIndicator = document.getElementById("hand-indicator");

    let model;
    let snake = [];
    let food = {};
    let maxLength = 50;
    let score = 0;
    let gameActive = false;
    let lastPredictionTime = 0;
    const predictionInterval = 100;
    let currentFacingMode = "environment";
    let cameraActive = false;
    let manualMode = false;
    let mouseX = 0, mouseY = 0;
    let handDetected = false;

    function resizeCanvas() {
      cameraCanvas.width = window.innerWidth;
      cameraCanvas.height = window.innerHeight;
    }
    
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    async function setupCamera(facingMode) {
      try {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: facingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        video.srcObject = stream;
        cameraActive = true;
        
        return new Promise(resolve => {
          video.onloadedmetadata = () => resolve(video);
        });
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", error);
        cameraActive = false;
        showPermissionError(error);
        return null;
      }
    }

    function showPermissionError(error) {
      startScreen.style.display = "none";
      gameOverScreen.style.display = "none";
      permissionScreen.style.display = "block";
      
      let errorMessage = "ØªØ¹Ø°Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‡Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†";
      
      if (error.name === "NotAllowedError") {
        errorMessage = "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.";
      } else if (error.name === "NotFoundError") {
        errorMessage = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
      } else if (error.name === "NotReadableError") {
        errorMessage = "Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† Ù‚Ø¨Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø¢Ø®Ø±. ÙŠØ±Ø¬Ù‰ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.";
      }
      
      errorDetailsElement.textContent = errorMessage;
    }

    function enableManualMode() {
      manualMode = true;
      cameraActive = false;
      permissionScreen.style.display = "none";
      startScreen.style.display = "none";
      gameOverScreen.style.display = "none";
      overlay.style.display = "none";
      cameraCanvas.style.background = "radial-gradient(circle, #101010, #000)";
      initGame();
      drawLoop();
    }

    function toggleManualMode() {
      if (manualMode) {
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        manualMode = false;
        manualModeBtn.textContent = "Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ";
        setupCamera(currentFacingMode).then(() => {
          if (gameActive) {
            video.play();
          }
        });
      } else {
        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        manualMode = true;
        cameraActive = false;
        manualModeBtn.textContent = "Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
          video.srcObject = null;
        }
        
        cameraCanvas.style.background = "radial-gradient(circle, #101010, #000)";
      }
    }

    async function main() {
      loadingElement.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ¯...";
      
      try {
        await tf.setBackend('webgl');
        model = await handpose.load();
        loadingElement.textContent = "Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø§Ù‡Ø²!";
        startButton.disabled = false;
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:", error);
        loadingElement.textContent = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
      }
    }

    function initGame() {
      snake = [{x: cameraCanvas.width/2, y: cameraCanvas.height/2}];
      randomFood();
      maxLength = 50;
      score = 0;
      scoreElement.textContent = "Ø§Ù„Ù†Ù‚Ø§Ø·: 0";
      gameActive = true;
      
      if (!manualMode) {
        overlay.style.display = "none";
      }
    }

    function randomFood() {
      food = {
        x: Math.random() * (cameraCanvas.width - 100) + 50,
        y: Math.random() * (cameraCanvas.height - 100) + 50
      };
    }

    function createParticles(x, y, color, count) {
      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.width = Math.random() * 15 + 8 + 'px';
        particle.style.height = particle.style.width;
        particle.style.backgroundColor = color;
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        
        document.getElementById('game-container').appendChild(particle);
        
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 4 + 2;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;
        
        let opacity = 0.7;
        const animate = () => {
          opacity -= 0.02;
          if (opacity <= 0) {
            particle.remove();
            return;
          }
          
          particle.style.opacity = opacity;
          particle.style.left = parseFloat(particle.style.left) + vx + 'px';
          particle.style.top = parseFloat(particle.style.top) + vy + 'px';
          
          requestAnimationFrame(animate);
        };
        
        animate();
      }
    }

    function drawGameInCamera(predictions) {
      if (!gameActive) return;
      
      // Ù…Ø³Ø­ canvas Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      cameraCtx.clearRect(0, 0, cameraCanvas.width, cameraCanvas.height);
      
      // Ø±Ø³Ù… ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙƒØ®Ù„ÙÙŠØ© (Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø´Ø·)
      if (cameraActive && !manualMode) {
        cameraCtx.drawImage(video, 0, 0, cameraCanvas.width, cameraCanvas.height);
        
        // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø´ÙØ§ÙØ© Ø¯Ø§ÙƒÙ†Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø±Ø¤ÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ±
        cameraCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        cameraCtx.fillRect(0, 0, cameraCanvas.width, cameraCanvas.height);
      }
      
      // Ø±Ø³Ù… Ø§Ù„Ø«Ø¹Ø¨Ø§Ù†
      cameraCtx.beginPath();
      for (let i = 1; i < snake.length; i++) {
        const progress = i / snake.length;
        const green = Math.floor(100 + 155 * progress);
        cameraCtx.strokeStyle = `rgb(0, ${green}, 0)`;
        cameraCtx.lineWidth = 12;
        cameraCtx.lineCap = "round";
        cameraCtx.lineJoin = "round";
        
        cameraCtx.beginPath();
        cameraCtx.moveTo(snake[i-1].x, snake[i-1].y);
        cameraCtx.lineTo(snake[i].x, snake[i].y);
        cameraCtx.stroke();
      }
      
      // Ø±Ø³Ù… Ø±Ø£Ø³ Ø§Ù„Ø«Ø¹Ø¨Ø§Ù†
      const head = snake[snake.length - 1];
      cameraCtx.beginPath();
      cameraCtx.arc(head.x, head.y, 15, 0, Math.PI * 2);
      cameraCtx.fillStyle = "lime";
      cameraCtx.fill();
      
      // Ø±Ø³Ù… Ø§Ù„ØªÙØ§Ø­Ø© ğŸ
      cameraCtx.beginPath();
      cameraCtx.arc(food.x, food.y, 25, 0, Math.PI * 2);
      cameraCtx.fillStyle = "red";
      cameraCtx.fill();
      
      // Ø±Ø³Ù… Ø³Ø§Ù‚ Ø§Ù„ØªÙØ§Ø­Ø©
      cameraCtx.beginPath();
      cameraCtx.moveTo(food.x - 8, food.y - 25);
      cameraCtx.lineTo(food.x, food.y - 35);
      cameraCtx.lineTo(food.x + 8, food.y - 25);
      cameraCtx.strokeStyle = "brown";
      cameraCtx.lineWidth = 4;
      cameraCtx.stroke();
      
      // Ø±Ø³Ù… ÙˆØ±Ù‚Ø© Ø§Ù„ØªÙØ§Ø­Ø©
      cameraCtx.beginPath();
      cameraCtx.ellipse(food.x + 10, food.y - 30, 10, 6, Math.PI/4, 0, Math.PI * 2);
      cameraCtx.fillStyle = "green";
      cameraCtx.fill();
      
      // Ø±Ø³Ù… Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠØ¯ Ø¥Ø°Ø§ ØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡Ø§ (ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
      if (predictions.length > 0 && cameraActive && !manualMode) {
        handDetected = true;
        handIndicator.style.display = "none";
        
        const landmarks = predictions[0].landmarks;
        
        // Ø±Ø³Ù… Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠØ¯
        cameraCtx.fillStyle = "lime";
        for (let i = 0; i < landmarks.length; i++) {
          const x = landmarks[i][0];
          const y = landmarks[i][1];
          
          cameraCtx.beginPath();
          cameraCtx.arc(x, y, 4, 0, 2 * Math.PI);
          cameraCtx.fill();
        }
        
        // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø­ÙˆÙ„ Ø§Ù„ÙŠØ¯
        const boundingBox = predictions[0].boundingBox;
        const startPoint = [boundingBox.topLeft[0], boundingBox.topLeft[1]];
        const endPoint = [boundingBox.bottomRight[0], boundingBox.bottomRight[1]];
        
        cameraCtx.strokeStyle = "lime";
        cameraCtx.lineWidth = 3;
        cameraCtx.strokeRect(startPoint[0], startPoint[1], 
                           endPoint[0] - startPoint[0], 
                           endPoint[1] - startPoint[1]);
        
        // ØªÙ…ÙŠÙŠØ² Ø¥ØµØ¨Ø¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø©
        const indexFinger = landmarks[8];
        
        cameraCtx.fillStyle = "red";
        cameraCtx.beginPath();
        cameraCtx.arc(indexFinger[0], indexFinger[1], 8, 0, 2 * Math.PI);
        cameraCtx.fill();
        
        // Ø±Ø³Ù… Ø®Ø· Ù…Ù† Ø¥ØµØ¨Ø¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© Ø¥Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ø«Ø¹Ø¨Ø§Ù†
        cameraCtx.strokeStyle = "yellow";
        cameraCtx.setLineDash([8, 8]);
        cameraCtx.lineWidth = 3;
        cameraCtx.beginPath();
        cameraCtx.moveTo(indexFinger[0], indexFinger[1]);
        cameraCtx.lineTo(head.x, head.y);
        cameraCtx.stroke();
        cameraCtx.setLineDash([]);
      } else if (!manualMode) {
        handDetected = false;
        handIndicator.style.display = "block";
      }
    }

    function checkCollision() {
      const head = snake[snake.length - 1];
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ø§Ù„Ù†ÙØ³ (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø±Ø§Ù†)
      for (let i = 0; i < snake.length - 15; i++) {
        const dx = head.x - snake[i].x;
        const dy = head.y - snake[i].y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < 20) {
          return true;
        }
      }
      
      return false;
    }

    function gameOver() {
      gameActive = false;
      finalScoreElement.textContent = "Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: " + score;
      gameOverScreen.style.display = "block";
      overlay.style.display = "flex";
    }

    async function drawLoop() {
      if (!gameActive) return;
      
      const currentTime = Date.now();
      let predictions = [];
      
      if (manualMode) {
        // ÙˆØ¶Ø¹ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ø§Ù„Ù„Ù…Ø³
        snake.push({x: mouseX, y: mouseY});
        if (snake.length > maxLength) snake.shift();
      } else if (currentTime - lastPredictionTime > predictionInterval && cameraActive) {
        // ÙˆØ¶Ø¹ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        predictions = await model.estimateHands(video);
        
        if (predictions.length > 0) {
          const x = predictions[0].landmarks[8][0];
          const y = predictions[0].landmarks[8][1];
          snake.push({x, y});
          
          if (snake.length > maxLength) snake.shift();
        }
        lastPredictionTime = currentTime;
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…Ø¹ Ø§Ù„Ø·Ø¹Ø§Ù…
      const head = snake[snake.length - 1];
      const dx = head.x - food.x;
      const dy = head.y - food.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      
      if (dist < 35) {
        createParticles(food.x, food.y, "red", 20);
        randomFood();
        maxLength += 5;
        score++;
        scoreElement.textContent = "Ø§Ù„Ù†Ù‚Ø§Ø·: " + score;
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù…
      if (checkCollision()) {
        gameOver();
        return;
      }
      
      // Ø±Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      drawGameInCamera(predictions);

      requestAnimationFrame(drawLoop);
    }

    // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù„Ù…Ø³
    cameraCanvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const rect = cameraCanvas.getBoundingClientRect();
      mouseX = e.touches[0].clientX - rect.left;
      mouseY = e.touches[0].clientY - rect.top;
    });

    // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø§ÙˆØ³ (Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ ØªØ¯Ø¹Ù… Ø§Ù„Ù…Ø§ÙˆØ³)
    cameraCanvas.addEventListener('mousemove', (e) => {
      const rect = cameraCanvas.getBoundingClientRect();
      mouseX = e.clientX - rect.left;
      mouseY = e.clientY - rect.top;
    });

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    cameraSwitch.addEventListener("click", async () => {
      if (manualMode) {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ");
        return;
      }
      
      currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
      const cameraReady = await setupCamera(currentFacingMode);
      if (cameraReady && gameActive) {
        video.play();
      }
    });

    manualModeBtn.addEventListener("click", toggleManualMode);

    startButton.addEventListener("click", async () => {
      const cameraReady = await setupCamera(currentFacingMode);
      if (cameraReady) {
        video.play();
        initGame();
        drawLoop();
      }
    });

    restartButton.addEventListener("click", () => {
      initGame();
      drawLoop();
    });

    retryButton.addEventListener("click", async () => {
      const cameraReady = await setupCamera(currentFacingMode);
      if (cameraReady) {
        video.play();
        permissionScreen.style.display = "none";
        initGame();
        drawLoop();
      }
    });

    manualModeButton.addEventListener("click", enableManualMode);

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    main();
  </script>
</body>
</html>